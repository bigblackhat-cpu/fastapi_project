name: "CI/CD"

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

jobs:
  Test:
    runs-on: ubuntu-latest
    environment: anything
    if: |
      github.event_name == 'pull_request' || 
      github.event_name == 'workflow_dispatch'
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      - name: just test
        run: echo "test over"

  Deploy:
        runs-on: ubuntu-latest
        environment: bbh_server
        if: |
          github.ref == 'refs/heads/main'
        steps:
          - name: connect to the host
            uses: appleboy/ssh-action@v1
            with:
              host: ${{ secrets.HOST }}
              username: ${{ secrets.USERNAME }}
              password: ${{ secrets.PASSWORD }}
              port: ${{ secrets.PORT }}
              script: |
                export PATH=$PATH:/root/.local/bin/
                cd /srv/fastapi_project/fastapi_project
                
                echo '=========basic env==========='
                # uv --version
                # git --version
                # docker --version
                # ps -p 1 -o comm=
                # systemctl --version
                # echo '=======start deploy pull "from main" ==========='
                git pull
                # cd ./fastapi_project/
                # echo '=======uv sync==========='
                
                uv sync --index-url https://pypi.tuna.tsinghua.edu.cn/simple
                echo '=======启动服务==========='
                # sudo systemctl restart fastapi_ocr.service
                echo '=======服务状态==========='
                # sudo systemctl status fastapi_ocr.service
                echo "pull over waiting systemctl config..."

